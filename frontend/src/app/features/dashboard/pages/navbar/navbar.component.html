<nav class="bg-white border-b border-gray-100 px-4 py-2.5 navbar">
  <div class="flex items-center justify-between">
    <!-- Left Side: Toggle & Title with breadcrumbs -->
    <div class="flex items-center">
      <!-- Sidebar Toggle Button with improved styling -->
      <button (click)="toggleSidebar()" class="toggle-button" pRipple>
        <i class="pi pi-bars"></i>
      </button>

      <!-- Dynamic Page Title with breadcrumb-style navigation -->
      <div class="hidden sm:flex items-center ml-4">
        <nav aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm">
            <li>
              <a routerLink="/dashboard" class="text-gray-500 hover:text-blue-600 transition-colors">Dashboard</a>
            </li>
            <li *ngIf="pageTitle !== 'Dashboard'" class="flex items-center space-x-2">
              <i class="pi pi-angle-right text-gray-400 text-xs"></i>
              <span class="text-gray-800 font-medium">{{ pageTitle }}</span>
            </li>
          </ol>
        </nav>
      </div>

      <!-- Mobile Title -->
      <h1 class="sm:hidden text-lg font-medium text-gray-800 ml-3">
        {{ pageTitle }}
      </h1>
    </div>

    <!-- Right Side: Actions & Profile with improved layout -->
    <div class="flex items-center space-x-1 md:space-x-3">


      <!-- Language Selector -->
      <div class="relative">
        <button pButton pRipple type="button" (click)="toggleLanguageDropdown()"
          class="language-selector p-button-text p-button-rounded flex items-center"
          [pTooltip]="'DASHBOARD.NAVBAR.CHANGE_LANGUAGE' | translate" tooltipPosition="bottom">
          <i class="pi pi-globe text-gray-600"></i>
          <span class="ml-1 hidden lg:inline-block text-gray-700">{{
            currentLang.toUpperCase()
            }}</span>
        </button>

        <!-- Language Dropdown -->
        <div *ngIf="showLanguageDropdown"
          class="language-dropdown absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
          <button (click)="switchLanguage('en')"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
            [ngClass]="{ 'bg-blue-50': currentLang === 'en' }">
            <div class="w-5 h-5 mr-3 relative overflow-hidden rounded-full">
              <!-- US flag SVG icon -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5">
                <path fill="#f0f0f0" d="M0 85.33h512v341.337H0z" />
                <g fill="#d80027">
                  <path d="M0 85.33h512v42.663H0zM0 170.66h512v42.663H0zM0 256h512v42.663H0zM0 341.33h512v42.663H0z" />
                </g>
                <path fill="#2e52b2" d="M0 85.33h256v170.663H0z" />
                <g fill="#f0f0f0">
                  <path
                    d="m99.82 160.624-4.184 12.883h-13.534l10.947 7.96-4.185 12.884 10.956-7.975 10.956 7.975-4.185-12.884 10.946-7.96h-13.533zM103.797 219.288l-4.185 12.883H86.08l10.947 7.96-4.183 12.884 10.954-7.975 10.957 7.975-4.185-12.884 10.946-7.96h-13.532zM43.663 219.288l-4.185 12.883H25.946l10.947 7.96-4.183 12.884 10.954-7.975 10.957 7.975-4.185-12.884 10.946-7.96H54.65zM43.663 160.624l-4.185 12.883H25.946l10.947 7.96-4.183 12.884 10.954-7.975 10.957 7.975-4.185-12.884 10.946-7.96H54.65zM155.57 160.624l-4.184 12.883h-13.533l10.946 7.96-4.185 12.884 10.956-7.975 10.956 7.975-4.185-12.884 10.947-7.96h-13.534zM155.57 219.288l-4.184 12.883h-13.533l10.946 7.96-4.185 12.884 10.956-7.975 10.956 7.975-4.185-12.884 10.947-7.96h-13.534zM43.663 102.85l-4.185 12.884H25.946l10.947 7.96-4.183 12.883 10.954-7.974 10.957 7.974-4.185-12.883 10.946-7.96H54.65zM103.797 102.85l-4.185 12.884H86.08l10.947 7.96-4.183 12.883 10.954-7.974 10.957 7.974-4.185-12.883 10.946-7.96h-13.532zM155.57 102.85l-4.184 12.884h-13.533l10.946 7.96-4.185 12.883 10.956-7.974 10.956 7.974-4.185-12.883 10.947-7.96h-13.534z" />
                </g>
              </svg>
            </div>
            <span>{{ "LANG.EN" | translate }}</span>
          </button>
          <button (click)="switchLanguage('fr')"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
            [ngClass]="{ 'bg-blue-50': currentLang === 'fr' }">
            <div class="w-5 h-5 mr-3 relative overflow-hidden rounded-full">
              <!-- French flag SVG icon -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5">
                <path fill="#f0f0f0" d="M0 85.33h512v341.337H0z" />
                <path fill="#0052b4" d="M0 85.33h170.663v341.337H0z" />
                <path fill="#d80027" d="M341.337 85.33H512v341.337H341.337z" />
              </svg>
            </div>
            <span>{{ "LANG.FR" | translate }}</span>
          </button>
        </div>      </div>

      <!-- Security Alerts -->
      <div class="relative" *ngIf="isStaff()">
        <button pButton pRipple type="button" (click)="toggleSecurityAlerts()"
          class="security-alerts-btn p-button-text p-button-rounded flex items-center relative"
          [pTooltip]="'Security Alerts' | translate" tooltipPosition="bottom">
          <i class="pi pi-shield text-gray-600" [class.text-red-600]="unreadSecurityAlerts > 0"></i>
          <span *ngIf="unreadSecurityAlerts > 0"
            class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
            {{ unreadSecurityAlerts > 99 ? '99+' : unreadSecurityAlerts }}
          </span>
          <i class="pi pi-wifi-slash text-red-500 text-xs absolute -bottom-1 -right-1" 
             *ngIf="!isSecurityConnected" 
             [pTooltip]="'Security service disconnected'" 
             tooltipPosition="bottom"></i>
        </button>

        <!-- Security Alerts Dropdown -->
        <div *ngIf="showSecurityAlerts"
          class="security-alerts-dropdown absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl z-50 border border-gray-200 max-h-96 overflow-hidden">
          
          <!-- Header -->
          <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <div class="flex items-center">
              <i class="pi pi-shield text-red-600 mr-2"></i>
              <h3 class="font-semibold text-gray-900">Security Alerts</h3>
              <span *ngIf="unreadSecurityAlerts > 0" 
                class="ml-2 bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">
                {{ unreadSecurityAlerts }} new
              </span>
            </div>
            <div class="flex items-center space-x-2">
              <button (click)="openSecurityMonitor()" 
                class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded"
                [pTooltip]="'Open Security Monitor'" tooltipPosition="bottom">
                <i class="pi pi-external-link"></i>
              </button>
              <button (click)="clearAllSecurityAlerts()" 
                class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 rounded"
                [pTooltip]="'Clear All'" tooltipPosition="bottom">
                <i class="pi pi-times"></i>
              </button>
            </div>
          </div>

          <!-- Connection Status -->
          <div *ngIf="!isSecurityConnected" 
            class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
            <div class="flex">
              <i class="pi pi-exclamation-triangle text-yellow-400 mr-2"></i>
              <div class="text-sm">
                <p class="text-yellow-700">Security service disconnected</p>
                <p class="text-yellow-600 text-xs">Real-time alerts may be delayed</p>
              </div>
            </div>
          </div>

          <!-- Alerts List -->
          <div class="max-h-80 overflow-y-auto">
            <div *ngIf="securityAlerts.length === 0" class="p-6 text-center text-gray-500">
              <i class="pi pi-check-circle text-4xl text-green-500 mb-2"></i>
              <p class="text-sm">No security alerts</p>
              <p class="text-xs text-gray-400">All tests are running smoothly</p>
            </div>

            <div *ngFor="let alert of securityAlerts; trackBy: trackByAlertId" 
              class="border-b border-gray-100 p-4 hover:bg-gray-50 transition-colors">
              
              <!-- Alert Header -->
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center">
                  <i [class]="'pi ' + getSecuritySeverityIcon(alert.severity)" 
                     [ngClass]="{
                       'text-red-600': alert.severity === 'CRITICAL',
                       'text-orange-500': alert.severity === 'HIGH',
                       'text-yellow-500': alert.severity === 'MEDIUM',
                       'text-blue-500': alert.severity === 'LOW'
                     }" class="mr-2"></i>
                  <span class="text-xs font-medium px-2 py-1 rounded"
                    [ngClass]="{
                      'bg-red-100 text-red-800': alert.severity === 'CRITICAL',
                      'bg-orange-100 text-orange-800': alert.severity === 'HIGH',
                      'bg-yellow-100 text-yellow-800': alert.severity === 'MEDIUM',
                      'bg-blue-100 text-blue-800': alert.severity === 'LOW'
                    }">
                    {{ alert.severity }}
                  </span>
                </div>
                <span class="text-xs text-gray-500">{{ getTimeElapsed(alert.timestamp) }}</span>
              </div>              <!-- Alert Content -->
              <div class="mb-2">
                <h4 class="font-medium text-sm text-gray-900">{{ formatAlertType(alert.alertType) }}</h4>
                <p class="text-sm text-gray-600 mt-1">{{ alert.description || 'No description available' }}</p>
              </div>              <!-- Candidate Info -->
              <div class="flex items-center text-xs text-gray-500 mb-3">
                <i class="pi pi-user mr-1"></i>
                <span>{{ alert.candidateName || alert.candidateId || 'Unknown Candidate' }}</span>
                <span class="mx-2" *ngIf="alert.testId">•</span>
                <i class="pi pi-file mr-1" *ngIf="alert.testId"></i>
                <span *ngIf="alert.testId">Test: {{ alert.testId }}</span>
                <span class="mx-2" *ngIf="isValidQuestionIndex(alert.questionIndex)">•</span>
                <i class="pi pi-question-circle mr-1" *ngIf="isValidQuestionIndex(alert.questionIndex)"></i>
                <span *ngIf="isValidQuestionIndex(alert.questionIndex)">Q{{ alert.questionIndex + 1 }}</span>
              </div>

              <!-- Warning Count (if applicable) -->
              <div *ngIf="alert.warningCount !== undefined" 
                class="text-xs text-gray-500 mb-3 flex items-center">
                <i class="pi pi-exclamation-triangle mr-1"></i>
                <span>Warning {{ alert.warningCount }} of {{ alert.maxWarnings || 3 }}</span>
              </div>

              <!-- Action Buttons -->
              <div class="flex items-center space-x-2">
                <button (click)="acknowledgeAlert(alert)"
                  class="text-xs bg-green-100 text-green-800 px-3 py-1 rounded hover:bg-green-200 transition-colors">
                  <i class="pi pi-check mr-1"></i>
                  Acknowledge
                </button>
                <button (click)="requestIntervention(alert)"
                  class="text-xs bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200 transition-colors"
                  *ngIf="alert.severity === 'CRITICAL' || alert.severity === 'HIGH'">
                  <i class="pi pi-exclamation-circle mr-1"></i>
                  Intervene
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p-toast position="top-right"></p-toast>
      <!-- User Dropdown with improved interaction -->
      <div class="relative">
        <button pButton class="p-button-text p-button-rounded user-menu-button" (click)="toggleUserDropdown()" pRipple>
          <!-- Profile picture with upload functionality -->
          <div class="avatar-container relative">
            <img [src]="
                avatarUrl ||
                'https://ui-avatars.com/api/?name=' +
                  encodeURIComponent(userFullName) +
                  '&background=3b82f6&color=fff&bold=true'
              " class="h-9 w-9 rounded-full border-2 border-white shadow-sm" [class.profile-loading]="isUploading"
              alt="User avatar" (error)="handleImageError()" (click)="$event.stopPropagation(); fileInput.click()" />
            <!-- Overlay with icon when hovering -->
            <div class="avatar-upload-overlay">
              <i class="pi pi-camera"></i>
            </div>
            <!-- Hidden file input -->
            <input #fileInput type="file" (change)="onFileSelected($event)"
              accept="image/png, image/jpeg, image/jpg, image/gif, image/webp" style="display: none" />
            <!-- Loading spinner -->
            <div *ngIf="isUploading" class="avatar-loading-spinner">
              <i class="pi pi-spin pi-spinner"></i>
            </div>
          </div>

          <span class="hidden md:block ml-2 font-medium text-sm text-gray-700">{{ userFullName }}</span>
          <i class="pi pi-chevron-down ml-1 text-xs transition-transform duration-200"
            [ngClass]="{ 'transform rotate-180': showUserDropdown }"></i>
        </button>

        <!-- Enhanced User Dropdown Menu -->
        <div *ngIf="showUserDropdown" class="user-dropdown">
          <div class="p-3 border-b border-gray-100">
            <div class="flex items-start">
              <div class="relative">
                <img [src]="
                    avatarUrl ||
                    'https://ui-avatars.com/api/?name=' +
                      encodeURIComponent(userFullName) +
                      '&background=3b82f6&color=fff&bold=true'
                  " class="h-10 w-10 rounded-full border-2 border-white shadow-sm object-cover"
                  [class.profile-loading]="isUploading" alt="User avatar" />
              </div>
              <div class="ml-3">
                <p class="font-medium text-gray-900">{{ userFullName }}</p>
                <p class="text-xs text-gray-500 mt-0.5">
                  {{ userEmail }}
                </p>
                <div class="mt-2">
                  <span
                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                    {{ userRole }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="py-1">
            <a class="user-dropdown-item" (click)="triggerProfilePictureUpload(); $event.preventDefault()">
              <i class="pi pi-camera"></i>
              <span>{{ "DASHBOARD.NAVBAR.PROFILE_PHOTO" | translate }}</span>
            </a>
            <a *ngIf="avatarUrl" class="user-dropdown-item" (click)="deleteProfilePicture(); $event.preventDefault()">
              <i class="pi pi-trash"></i>
              <span>{{ "DASHBOARD.NAVBAR.DELETE_PHOTO" | translate }}</span>
            </a>
            <a [routerLink]="'/profile'" class="user-dropdown-item">
              <i class="pi pi-user"></i>
              <span>{{ "DASHBOARD.NAVBAR.PROFILE" | translate }}</span>
            </a>
            <a [routerLink]="'/home'" class="user-dropdown-item">
              <i class="pi pi-home"></i>
              <span>{{ "DASHBOARD.NAVBAR.HOME" | translate }}</span>
            </a>
          </div>

          <div class="py-1 border-t border-gray-100">
            <button (click)="logout()" class="user-dropdown-item text-red-600 w-full text-left" type="button">
              <i class="pi pi-sign-out"></i>
              <span>{{ "DASHBOARD.NAVBAR.SIGN_OUT" | translate }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>