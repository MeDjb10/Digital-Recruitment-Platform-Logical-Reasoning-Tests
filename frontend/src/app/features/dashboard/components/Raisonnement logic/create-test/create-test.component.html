<div
  class="max-w-[900px] mx-auto my-8 animate-[fadeIn_0.3s_ease-in-out] shadow-lg"
>
  <p-card styleClass="overflow-hidden rounded-xl">
    <ng-template pTemplate="header">
      <div
        class="flex items-center justify-between px-6 py-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100"
      >
        <div class="flex items-center gap-4">
          <div
            class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20"
          >
            <i
              class="pi text-2xl"
              [ngClass]="isEditMode ? 'pi-pencil' : 'pi-file-edit'"
            ></i>
          </div>
          <div>
            <h1
              class="text-[1.75rem] font-semibold text-slate-800 m-0 leading-tight"
            >
              {{ pageTitle }}
            </h1>
            <p class="text-slate-500 text-[0.95rem] mt-1.5 mb-0">
              {{ pageSubtitle }}
            </p>
          </div>
        </div>
        <div>
          <button
            pButton
            icon="pi pi-arrow-left"
            label="Back to Tests"
            class="p-button-text hover:bg-blue-50/70 transition-all"
            (click)="goBack()"
          ></button>
        </div>
      </div>
    </ng-template>

    <div
      *ngIf="creating && isEditMode"
      class="flex flex-col items-center justify-center py-16 px-4 text-center"
    >
      <p-progressSpinner styleClass="w-4rem h-4rem"></p-progressSpinner>
      <p class="mt-6 text-slate-500 text-lg">Loading test data...</p>
    </div>

    <form
      [formGroup]="testForm"
      (ngSubmit)="onSubmit()"
      class="px-6 py-5"
      *ngIf="!isEditMode || !creating"
    >
      <p-fieldset
        legend="Test Information"
        [toggleable]="true"
        [collapsed]="false"
        styleClass="mb-6 shadow-sm"
      >
        <div class="p-fluid form-grid m-1">
          <div class="mb-6">
            <label
              for="name"
              class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
              >Test Name*</label
            >
            <div class="p-inputgroup">
              <span class="p-inputgroup-addon bg-slate-50">
                <i class="pi pi-id-card"></i>
              </span>
              <input
                id="name"
                type="text"
                pInputText
                formControlName="name"
                placeholder="Enter descriptive test name"
                [ngClass]="{
                  'ng-invalid ng-dirty': submitted && f['name'].errors
                }"
                pTooltip="Give your test a clear, descriptive name"
                tooltipPosition="right"
                class="py-2.5"
              />
            </div>
            <small
              class="p-error mt-1.5 block"
              *ngIf="submitted && f['name'].errors?.['required']"
            >
              Test name is required.
            </small>
          </div>

          <div class="mb-6">
            <p-floatlabel variant="on">
              <textarea
                id="description"
                pInputTextarea
                formControlName="description"
                [rows]="3"
                style="resize: none; width: 100%"
                class="h-full py-3 px-4"
                [ngClass]="{
                  'ng-invalid ng-dirty': submitted && f['description'].errors
                }"
                pTooltip="Provide a clear description that explains what this test evaluates"
                tooltipPosition="right"
              ></textarea>
              <label for="description" class="text-[0.95rem]"
                >Description*</label
              >
            </p-floatlabel>
            <small
              class="p-error mt-1.5 block"
              *ngIf="submitted && f['description'].errors?.['required']"
            >
              Description is required.
            </small>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
            <div class="mb-2">
              <label
                for="category"
                class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
                >Category*</label
              >
              <p-dropdown
                id="category"
                formControlName="category"
                [options]="categoryOptions"
                optionLabel="label"
                optionValue="value"
                [placeholder]="'Select Category'"
                [ngClass]="{
                  'ng-invalid ng-dirty': submitted && f['category'].errors
                }"
                pTooltip="Choose the category this test belongs to"
                tooltipPosition="right"
                styleClass="w-full"
                [style]="{ width: '100%' }"
              ></p-dropdown>
              <small
                class="p-error mt-1.5 block"
                *ngIf="submitted && f['category'].errors?.['required']"
              >
                Category is required.
              </small>
            </div>

            <div class="mb-2">
              <label
                for="version"
                class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
                >Version</label
              >
              <p-dropdown
                id="version"
                formControlName="version"
                [options]="versionOptions"
                optionLabel="label"
                optionValue="value"
                [placeholder]="'Select Version'"
                pTooltip="Select the version of this test"
                tooltipPosition="left"
                styleClass="w-full"
                [style]="{ width: '100%' }"
              ></p-dropdown>
            </div>
          </div>

          <div class="grid grid-cols-1 mb-4">
            <div class="mb-2">
              <label
                for="totalQuestions"
                class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
                >Number of Questions*</label
              >
              <p-inputNumber
                id="totalQuestions"
                formControlName="totalQuestions"
                [min]="1"
                [max]="100"
                [showButtons]="true"
                placeholder="10"
                [ngClass]="{
                  'ng-invalid ng-dirty': submitted && f['totalQuestions'].errors
                }"
                pTooltip="Set how many questions this test will contain"
                tooltipPosition="right"
                styleClass="w-full md:w-1/3"
              ></p-inputNumber>
              <small
                class="p-error mt-1.5 block"
                *ngIf="submitted && f['totalQuestions'].errors?.['required']"
              >
                Number of questions is required.
              </small>
              <small class="text-sm text-slate-500 mt-2 block">
                This helps candidates understand the scope of the test
              </small>
            </div>
          </div>
        </div>
      </p-fieldset>

      <p-fieldset
        legend="Test Type"
        [toggleable]="true"
        [collapsed]="false"
        styleClass="mb-6 shadow-sm"
      >
        <div class="mb-6">
          <label class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
            >Test Type*</label
          >
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
            <div
              class="border border-slate-200 rounded-lg p-5 transition-all duration-200 bg-slate-50 cursor-pointer hover:shadow-md hover:-translate-y-0.5"
              [class.border-blue-500]="testForm.get('type')?.value === 'domino'"
              [class.bg-blue-50]="testForm.get('type')?.value === 'domino'"
              [class.shadow-[0_0_0_2px_rgba(59,130,246,0.2)]="
                testForm.get('type')?.value === 'domino'
              "
            >
              <div class="flex items-center gap-2 mb-3">
                <p-radioButton
                  formControlName="type"
                  value="domino"
                  inputId="domino"
                ></p-radioButton>
                <label for="domino" class="font-semibold text-slate-700"
                  >Domino Test</label
                >
              </div>
              <div class="flex items-start gap-3 pl-6">
                <i class="pi pi-th-large text-2xl text-blue-500"></i>
                <p class="text-sm text-slate-500 leading-relaxed m-0">
                  Test with domino patterns where candidates identify logical
                  relationships and patterns.
                </p>
              </div>
            </div>

            <div
              class="border border-slate-200 rounded-lg p-5 transition-all duration-200 bg-slate-50 cursor-pointer hover:shadow-md hover:-translate-y-0.5"
              [class.border-blue-500]="
                testForm.get('type')?.value === 'multiple-choice'
              "
              [class.bg-blue-50]="
                testForm.get('type')?.value === 'multiple-choice'
              "
              [class.shadow-[0_0_0_2px_rgba(59,130,246,0.2)]="
                testForm.get('type')?.value === 'multiple-choice'
              "
            >
              <div class="flex items-center gap-2 mb-3">
                <p-radioButton
                  formControlName="type"
                  value="multiple-choice"
                  inputId="multiple-choice"
                ></p-radioButton>
                <label
                  for="multiple-choice"
                  class="font-semibold text-slate-700"
                  >Multiple Choice</label
                >
              </div>
              <div class="flex items-start gap-3 pl-6">
                <i class="pi pi-list text-2xl text-blue-500"></i>
                <p class="text-sm text-slate-500 leading-relaxed m-0">
                  Traditional multiple-choice questions with several possible
                  answers.
                </p>
              </div>
            </div>

            <div
              class="border border-slate-200 rounded-lg p-5 transition-all duration-200 bg-slate-50 cursor-pointer hover:shadow-md hover:-translate-y-0.5"
              [class.border-blue-500]="testForm.get('type')?.value === 'verbal'"
              [class.bg-blue-50]="testForm.get('type')?.value === 'verbal'"
              [class.shadow-[0_0_0_2px_rgba(59,130,246,0.2)]="
                testForm.get('type')?.value === 'verbal'
              "
            >
              <div class="flex items-center gap-2 mb-3">
                <p-radioButton
                  formControlName="type"
                  value="verbal"
                  inputId="verbal"
                ></p-radioButton>
                <label for="verbal" class="font-semibold text-slate-700"
                  >Verbal Assessment</label
                >
              </div>
              <div class="flex items-start gap-3 pl-6">
                <i class="pi pi-comments text-2xl text-blue-500"></i>
                <p class="text-sm text-slate-500 leading-relaxed m-0">
                  Text-based questions to evaluate verbal reasoning and language
                  skills.
                </p>
              </div>
            </div>
          </div>

          <small
            class="p-error mt-1.5 block"
            *ngIf="submitted && f['type'].errors?.['required']"
          >
            Test type is required.
          </small>
        </div>
      </p-fieldset>

      <p-fieldset
        legend="Test Settings"
        [toggleable]="true"
        [collapsed]="false"
        styleClass="mb-6 shadow-sm"
      >
        <div class="p-fluid">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
            <div class="mb-2">
              <label
                for="duration"
                class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
                >Duration (minutes)*</label
              >
              <p-inputNumber
                id="duration"
                formControlName="duration"
                [min]="1"
                [max]="120"
                [showButtons]="true"
                placeholder="30"
                [ngClass]="{
                  'ng-invalid ng-dirty': submitted && f['duration'].errors
                }"
                pTooltip="Set the time limit for completing the test"
                tooltipPosition="right"
                styleClass="w-full"
              ></p-inputNumber>
              <small
                class="p-error mt-1.5 block"
                *ngIf="submitted && f['duration'].errors?.['required']"
              >
                Duration is required.
              </small>
            </div>

            <div class="mb-2">
              <label
                for="difficulty"
                class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
                >Difficulty Level*</label
              >
              <p-dropdown
                id="difficulty"
                formControlName="difficulty"
                [options]="difficultyOptions"
                optionLabel="label"
                optionValue="value"
                [placeholder]="'Select Difficulty'"
                [ngClass]="{
                  'ng-invalid ng-dirty': submitted && f['difficulty'].errors
                }"
                pTooltip="Choose a difficulty level that matches the test content"
                tooltipPosition="left"
                styleClass="w-full"
                [style]="{ width: '100%' }"
              ></p-dropdown>
              <small
                class="p-error mt-1.5 block"
                *ngIf="submitted && f['difficulty'].errors?.['required']"
              >
                Difficulty is required.
              </small>
            </div>
          </div>

          <div class="mb-6">
            <label
              for="tags"
              class="block font-medium text-slate-700 mb-2.5 text-[0.95rem]"
              >Tags</label
            >

            <div class="mb-3">
              <p-autoComplete
                [(ngModel)]="newTag"
                [ngModelOptions]="{ standalone: true }"
                [suggestions]="filteredTags"
                [dropdown]="true"
                placeholder="Type to search or add tags"
                [minLength]="1"
                (completeMethod)="filterTags($event)"
                (onSelect)="selectTag($event)"
                (onKeyUp)="$event.key === 'Enter' && addTag()"
                styleClass="w-full"
              >
                <ng-template let-tag pTemplate="item">
                  <div class="flex items-center text-slate-700 py-1.5">
                    <i class="pi pi-tag mr-2"></i>
                    <span>{{ tag }}</span>
                  </div>
                </ng-template>
              </p-autoComplete>
            </div>

            <div
              *ngIf="(testForm.get('tags')?.value || []).length > 0"
              class="flex flex-wrap gap-2 my-3 py-1"
            >
              <p-chip
                *ngFor="let tag of testForm.get('tags')?.value || []"
                [label]="tag"
                [removable]="true"
                (onRemove)="removeTag(tag)"
                styleClass="tag-chip"
              ></p-chip>
            </div>

            <small
              *ngIf="(testForm.get('tags')?.value || []).length === 0"
              class="flex items-center text-slate-500 italic mt-2"
            >
              <i class="pi pi-info-circle mr-1.5"></i> No tags added yet
            </small>
          </div>
        </div>
      </p-fieldset>

      <p-fieldset
        legend="Instructions"
        [toggleable]="true"
        [collapsed]="false"
        styleClass="mb-6 shadow-sm"
      >
        <div class="mb-6">
          <p-floatlabel variant="on">
            <textarea
              id="instructions"
              pInputTextarea
              formControlName="instructions"
              [rows]="4"
              style="resize: none; width: 100%"
              class="h-full py-3 px-4"
              pTooltip="Include any specific instructions or rules for taking the test"
              tooltipPosition="right"
            ></textarea>
            <label for="instructions" class="text-[0.95rem]"
              >Test Instructions</label
            >
          </p-floatlabel>
          <small class="text-sm text-slate-500 mt-2 block">
            These instructions will be displayed to candidates before they start
            the test
          </small>
        </div>
      </p-fieldset>

      <p-fieldset
        legend="Availability"
        [toggleable]="true"
        [collapsed]="false"
        styleClass="mb-6 shadow-sm"
      >
        <div class="mb-4">
          <div class="flex flex-col gap-2">
            <div class="flex items-center gap-3">
              <p-checkbox
                formControlName="isActive"
                [binary]="true"
                inputId="isActive"
              ></p-checkbox>
              <label for="isActive" class="font-medium text-slate-700 m-0">
                Make test active
              </label>
            </div>
            <small class="text-sm text-slate-500 ml-8">
              When active, this test can be assigned to candidates
            </small>
          </div>
        </div>
      </p-fieldset>

      <div class="flex justify-end gap-4 mt-8 pt-4 border-t border-slate-200">
        <button
          pButton
          type="button"
          label="Cancel"
          icon="pi pi-times"
          class="p-button-outlined px-5 py-2.5"
          (click)="goBack()"
        ></button>
        <button
          pButton
          type="submit"
          [label]="submitButtonLabel"
          icon="pi pi-check"
          [loading]="creating"
          class="px-5 py-2.5"
        ></button>
      </div>
    </form>
  </p-card>
</div>

<p-toast position="top-right"></p-toast>
