<div class="max-w-vw mx-auto">
  <div class="mb-8 text-center">
    <h1 class="text-3xl mb-2.5 text-slate-800">Your Assigned Tests</h1>
    <p class="text-lg text-slate-500">
      Complete your assigned assessment tests
    </p>
  </div>

  <div class="flex flex-col items-center py-10" *ngIf="loading">
    <div
      class="w-10 h-10 rounded-full border-4 border-slate-200 border-t-blue-500 animate-spin mb-4"
    ></div>
    <p>Loading your assigned tests...</p>
  </div>

  <div class="">
    <div
      class="grid grid-cols-2 col-span-1 gap-5 mb-8"
      *ngIf="!loading && assignedTests.length > 0"
    >
      <div
        class="bg-white rounded-xl shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all border-l-4 border-l-blue-500 overflow-hidden flex flex-col"
        *ngFor="let test of assignedTests; trackBy: trackByTestId"
      >
        <div class="p-6 flex-grow">
          <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl text-slate-800">{{ test.name }}</h2>
            <!-- Status indicator -->
            <span
              *ngIf="!testAttemptStatus[test._id || test.id]?.hasAttempt"
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
            >
              <i class="pi pi-circle mr-1 text-xs"></i>
              Ready to Start
            </span>
            <span
              *ngIf="
                testAttemptStatus[test._id || test.id]?.hasAttempt &&
                testAttemptStatus[test._id || test.id]?.status === 'in-progress'
              "
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800"
            >
              <i class="pi pi-clock mr-1 text-xs"></i>
              In Progress
            </span>
            <span
              *ngIf="
                testAttemptStatus[test._id || test.id]?.hasAttempt &&
                testAttemptStatus[test._id || test.id]?.status === 'completed'
              "
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
            >
              <i class="pi pi-check mr-1 text-xs"></i>
              Completed
            </span>
            <span
              *ngIf="
                testAttemptStatus[test._id || test.id]?.hasAttempt &&
                testAttemptStatus[test._id || test.id]?.status === 'timed-out'
              "
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"
            >
              <i class="pi pi-clock mr-1 text-xs"></i>
              Timed Out
            </span>
            <span
              *ngIf="
                testAttemptStatus[test._id || test.id]?.hasAttempt &&
                testAttemptStatus[test._id || test.id]?.status === 'abandoned'
              "
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
            >
              <i class="pi pi-times mr-1 text-xs"></i>
              Abandoned
            </span>
          </div>
          <p class="text-slate-500 mb-5 leading-relaxed line-clamp-3">
            {{ test.description }}
          </p>
          <div class="flex flex-wrap gap-4 mt-5">
            <div class="flex items-center gap-2 text-slate-500 text-sm">
              <i class="pi pi-clock"></i>
              <span>{{ test.duration }} minutes</span>
            </div>
            <div class="flex items-center gap-2 text-slate-500 text-sm">
              <i class="pi pi-list"></i>
              <span>{{ test.totalQuestions }} questions</span>
            </div>
            <div
              class="flex items-center gap-2 text-slate-500 text-sm"
              *ngIf="test.difficulty"
            >
              <i class="pi pi-star"></i>
              <span>{{ test.difficulty | titlecase }}</span>
            </div>
            <div
              class="flex items-center gap-2 text-slate-500 text-sm"
              *ngIf="test.category"
            >
              <i class="pi pi-tag"></i>
              <span>{{ test.category | titlecase }}</span>
            </div>
            <div
              class="flex items-center gap-2 text-slate-500 text-sm"
              *ngIf="test.isMainTest"
            >
              <i class="pi pi-bookmark"></i>
              <span>Main Test</span>
            </div>
            <div
              class="flex items-center gap-2 text-slate-500 text-sm"
              *ngIf="!test.isMainTest"
            >
              <i class="pi pi-plus"></i>
              <span>Additional Test</span>
            </div>
          </div>
          <!-- Additional info for completed tests -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'completed'
            "
            class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg"
          >
            <div class="flex items-center justify-between text-sm">
              <span class="text-green-700 font-medium">Test Completed</span>
              <span
                *ngIf="testAttemptStatus[test._id || test.id]?.percentageScore"
                class="text-green-600 font-bold"
              >
                Score:
                {{ testAttemptStatus[test._id || test.id]?.percentageScore }}%
              </span>
            </div>
            <div
              class="text-xs text-green-600 mt-1"
              *ngIf="testAttemptStatus[test._id || test.id]?.endTime"
            >
              Completed on:
              {{
                testAttemptStatus[test._id || test.id]?.endTime | date : "short"
              }}
            </div>
          </div>

          <!-- Additional info for in-progress tests -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'in-progress'
            "
            class="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg"
          >
            <div class="flex items-center justify-between text-sm">
              <span class="text-orange-700 font-medium">Test Started</span>
            </div>
            <div
              class="text-xs text-orange-600 mt-1"
              *ngIf="testAttemptStatus[test._id || test.id]?.startTime"
            >
              Started on:
              {{
                testAttemptStatus[test._id || test.id]?.startTime
                  | date : "short"
              }}
            </div>
          </div>

          <!-- Additional info for timed-out tests -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'timed-out'
            "
            class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg"
          >
            <div class="flex items-center justify-between text-sm">
              <span class="text-red-700 font-medium">Test Timed Out</span>
              <span
                *ngIf="testAttemptStatus[test._id || test.id]?.percentageScore"
                class="text-red-600 font-bold"
              >
                Score:
                {{ testAttemptStatus[test._id || test.id]?.percentageScore }}%
              </span>
            </div>
            <div
              class="text-xs text-red-600 mt-1"
              *ngIf="testAttemptStatus[test._id || test.id]?.endTime"
            >
              Timed out on:
              {{
                testAttemptStatus[test._id || test.id]?.endTime | date : "short"
              }}
            </div>
          </div>

          <!-- Additional info for abandoned tests -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'abandoned'
            "
            class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg"
          >
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-700 font-medium">Test Abandoned</span>
            </div>
            <div
              class="text-xs text-gray-600 mt-1"
              *ngIf="testAttemptStatus[test._id || test.id]?.endTime"
            >
              Abandoned on:
              {{
                testAttemptStatus[test._id || test.id]?.endTime | date : "short"
              }}
            </div>
          </div>
        </div>
        <div
          class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end"
        >
          <!-- No attempt yet - Show Start Test button -->
          <a
            *ngIf="!testAttemptStatus[test._id || test.id]?.hasAttempt"
            [routerLink]="['/tests', test._id || test.id]"
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-blue-500 text-white hover:bg-blue-600 transition-colors"
          >
            <i class="pi pi-play mr-2"></i>
            Start Test
          </a>

          <!-- Attempt in progress - Show Continue Test button -->
          <a
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'in-progress'
            "
           [routerLink]="['/tests', test._id || test.id]"
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-orange-500 text-white hover:bg-orange-600 transition-colors"
          >
            <i class="pi pi-forward mr-2"></i>
            Continue Test
          </a>

          <!-- Attempt completed - Show Completed status -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'completed'
            "
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-green-500 text-white cursor-not-allowed"
          >
            <i class="pi pi-check mr-2"></i>
            Completed
            <span
              *ngIf="testAttemptStatus[test._id || test.id]?.percentageScore"
              class="ml-2"
            >
              ({{ testAttemptStatus[test._id || test.id]?.percentageScore }}%)
            </span>
          </div>

          <!-- Attempt timed out - Show Timed Out status -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'timed-out'
            "
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-red-500 text-white cursor-not-allowed"
          >
            <i class="pi pi-clock mr-2"></i>
            Timed Out
            <span
              *ngIf="testAttemptStatus[test._id || test.id]?.percentageScore"
              class="ml-2"
            >
              ({{ testAttemptStatus[test._id || test.id]?.percentageScore }}%)
            </span>
          </div>

          <!-- Attempt abandoned - Show Abandoned status -->
          <div
            *ngIf="
              testAttemptStatus[test._id || test.id]?.hasAttempt &&
              testAttemptStatus[test._id || test.id]?.status === 'abandoned'
            "
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-gray-500 text-white cursor-not-allowed"
          >
            <i class="pi pi-times mr-2"></i>
            Abandoned
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-8" *ngIf="!loading && testAssignment">
    <div class="bg-sky-50 border border-sky-500 rounded-xl p-6">
      <h3 class="text-sky-900 mb-4 text-lg">Assignment Details</h3>
      <div class="space-y-2 text-gray-700">
        <p>
          <strong>Assignment Date:</strong>
          {{ testAssignment.assignmentDate | date : "medium" }}
        </p>
        <p *ngIf="testAssignment.examDate">
          <strong>Exam Date:</strong>
          {{ testAssignment.examDate | date : "medium" }}
        </p>
        <p *ngIf="testAssignment.assignedBy">
          <strong>Assigned By:</strong>
          {{ testAssignment.assignedBy.firstName }}
          {{ testAssignment.assignedBy.lastName }}
        </p>
        <p>
          <strong>Assignment Type:</strong>
          {{
            testAssignment.isManualAssignment
              ? "Manual Assignment"
              : "Automatic Assignment"
          }}
        </p>
      </div>
    </div>
  </div>
  <div
    class="text-center p-10 bg-white rounded-xl shadow-sm"
    *ngIf="!loading && assignedTests.length === 0 && !errorMessage"
  >
    <div class="message-content">
      <i class="pi pi-info-circle text-4xl text-slate-500 mb-4"></i>
      <h3 class="text-slate-800 mb-3">No Tests Assigned</h3>
      <p *ngIf="authorizationStatus === 'not_submitted'">
        You haven't submitted a test authorization request yet.
      </p>
      <p *ngIf="authorizationStatus === 'pending'">
        Your test authorization request is pending approval.
      </p>
      <p *ngIf="authorizationStatus === 'rejected'">
        Your test authorization request was rejected. Please contact an
        administrator.
      </p>
      <p *ngIf="authorizationStatus === 'approved'">
        You are approved for testing, but no tests have been assigned yet.
        Please contact an administrator.
      </p>
      <a
        routerLink="/dashboard"
        class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-slate-100 text-slate-700 border border-slate-200 hover:bg-slate-200 transition-colors"
        >Return to Dashboard</a
      >
    </div>
  </div>

  <div
    class="text-center p-10 bg-white rounded-xl shadow-sm"
    *ngIf="errorMessage"
  >
    <i class="pi pi-exclamation-triangle text-4xl text-red-500 mb-4"></i>
    <h3 class="text-slate-800 mb-3">Unable to Load Tests</h3>
    <p class="text-slate-500 mb-6 leading-relaxed">{{ errorMessage }}</p>
    <button
      (click)="loadAssignedTests()"
      class="inline-flex items-center justify-center px-5 py-2.5 rounded-md font-medium bg-slate-100 text-slate-700 border border-slate-200 hover:bg-slate-200 transition-colors"
    >
      Try Again
    </button>
  </div>
</div>
